import { useCompactTimetable } from '@/hooks/use-timetable'
import { CLASS_TIME, WEEK_DAYS, type CourseKey } from '@/utils/constants'
import { createFileRoute } from '@tanstack/react-router'
import { Dropdown, DropdownTrigger, DropdownMenu, DropdownItem } from "@heroui/dropdown";
import { Button } from '@heroui/button';
import { Calendar, CalendarHeartIcon, ClockIcon, MapPinIcon, UserIcon } from 'lucide-react';
import { extractTimetableEntries } from '@/utils';
import { Card, CardBody, CardHeader } from '@heroui/card';


export const Route = createFileRoute('/timetable')({
  validateSearch: (search: Record<string, unknown>) => {
    return {
      course: search.course as CourseKey,
      batch: search.batch as string,
    }
  },
  component: RouteComponent,
})

function RouteComponent() {
  const params = Route.useSearch()
  const { data, error, loading, day, setDay } =
    useCompactTimetable(params.course)

  if (loading)
    return <div className="text-default-500">Loading timetableâ€¦</div>
  if (error)
    return <div className="text-danger">{error}</div>
  if (!data) return null

  return (
    <div className="relative flex flex-col mx-auto gap-8 px-8 pt-20 max-w-3xl">
      <div className="fixed bottom-6 right-6 md:right-1/6 z-50">
        <Dropdown placement="top-end">
          <DropdownTrigger>
            <Button isIconOnly radius="full" size="lg" variant="shadow">
              <Calendar />
            </Button>
          </DropdownTrigger>

          <DropdownMenu
            aria-label="Select Day"
            selectedKeys={[String(day)]}
            onAction={(key) => setDay(Number(key))}
          >
            {WEEK_DAYS.map((label, index) => (
              <DropdownItem key={index}>{label}</DropdownItem>
            ))}
          </DropdownMenu>
        </Dropdown>
      </div>

      {data.map((item, index) => {
        const entry = extractTimetableEntries(
          params.batch,
          item.data
        )

        return (
          <section key={index} className="space-y-3">
            <div className="text-xl text-muted-foreground font-mono">
              <Button variant="light" radius="full">
                {CLASS_TIME[item.time]}
              </Button>
            </div>

            {!entry || entry.length === 0 ? (
              <Card>
                <CardHeader className="flex items-center gap-2 text-neutral-300">
                  <ClockIcon size={16} />
                  <span>Free Time</span>
                </CardHeader>
              </Card>
            ) : (
              entry.map((ele, i) => (
                <Card key={i}>
                  <CardHeader>{ele.courseCode}</CardHeader>
                  <CardBody className="space-y-2">
                    <div className="flex items-center gap-2">
                      <UserIcon size={16} className="text-neutral-400" />
                      {ele.teacherCode}
                    </div>

                    <div className="flex items-center gap-2">
                      <MapPinIcon size={16} className="text-neutral-400" />
                      {ele.venue}
                    </div>

                    <div className="flex items-center gap-2">
                      <CalendarHeartIcon size={16} className="text-neutral-400" />
                      {ele.classType}
                    </div>
                  </CardBody>
                </Card>
              ))
            )}
          </section>
        )
      })}
    </div>
  )
}
